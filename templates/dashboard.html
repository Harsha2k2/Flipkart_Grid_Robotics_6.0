<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #fff;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header {
            padding: 20px 40px;
            border-bottom: 1px solid #eee;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 0;
        }

        .nav-tab {
            color: #666;
            text-decoration: none;
            padding: 10px 0;
        }

        .nav-tab.active {
            color: #000;
            border-bottom: 2px solid #000;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            position: relative;
        }

        .card-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: #e2e8f0;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .card-label {
            color: #666;
            font-size: 14px;
        }

        .card-sublabel {
            color: #999;
            font-size: 12px;
        }

        .charts-section {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            width: 30%;
            height: 300px;
        }

        .chart-card canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .recent-scans {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            width: 70%;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination-button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .download-button {
            padding: 8px 16px;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .home-button {
            padding: 10px 0;
            color: #666;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            background: none;
            border: none;
        }

        .home-button:hover {
            color: #000;
        }

        .home-button.active {
            color: #000;
            border-bottom: 2px solid #000;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        /* Update table styles */
        .recent-scans table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
        }

        .recent-scans th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 500;
            text-align: left;
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid #e2e8f0;
        }

        .recent-scans td {
            padding: 12px 16px;
            font-size: 13px;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
        }

        .recent-scans tr:hover td {
            background-color: #f8fafc;
        }

        /* Type badges */
        .type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .type-fresh {
            background-color: #dcfce7;
            color: #166534;
        }

        .type-branded {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .type-all {
            background-color: #fef3c7;
            color: #92400e;
        }

        /* Details styling */
        .freshness-good {
            color: #059669;
        }

        .freshness-average {
            color: #d97706;
        }

        .freshness-poor {
            color: #dc2626;
        }

        /* Life indicator */
        .life-days {
            font-weight: 500;
        }

        /* Table header */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 16px;
        }

        .table-header h2 {
            font-size: 18px;
            color: #0f172a;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-actions">
            <a href="/" class="home-button">
                <i class="fas fa-home"></i>
                Home
            </a>
            <div class="nav-tabs">
                <a href="#" class="nav-tab active">Overview</a>
                <a href="#" class="nav-tab">Inventory (coming soon)</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <div>
                <h1>Welcome to Product Analysis</h1>
            </div>
            <button onclick="exportToCSV()" class="download-button">Download Report</button>
        </div>

        <div class="cards-container">
            <div class="card">
                <i class="card-icon fas fa-chart-line"></i>
                <div class="card-value">{{ stats.total_products }}</div>
                <div class="card-label">Total Scans</div>
                <div class="card-sublabel">{{ stats.todays_branded_scans + stats.todays_fresh_scans }} scans today</div>
            </div>
            <div class="card">
                <i class="card-icon fas fa-cube"></i>
                <div class="card-value">{{ stats.total_items }}</div>
                <div class="card-label">Total Products</div>
                <div class="card-sublabel">All items counted</div>
            </div>
            <div class="card">
                <i class="card-icon fas fa-box"></i>
                <div class="card-value">{{ stats.branded_products }}</div>
                <div class="card-label">Branded Products</div>
                <div class="card-sublabel">Packaged items scanned</div>
            </div>
            <div class="card">
                <i class="card-icon fas fa-leaf"></i>
                <div class="card-value">{{ stats.fresh_products }}</div>
                <div class="card-label">Fresh Produce</div>
                <div class="card-sublabel">Fresh items scanned</div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <h2>Distribution</h2>
                <canvas id="productTypeChart"></canvas>
            </div>
            
            <div class="recent-scans">
                <div class="table-header">
                    <h2>Recent Scans</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Item</th>
                            <th>Details</th>
                            <th>Qty</th>
                            <th>Life</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in recent_scans[:10] %}
                        <tr>
                            <td>{{ scan.serial_number }}</td>
                            <td>{{ scan.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <span class="type-badge type-{{ scan.product_type }}">
                                    {{ scan.product_type }}
                                </span>
                            </td>
                            <td>{{ scan.name }}</td>
                            <td class="{% if 'Good' in scan.freshness %}freshness-good
                                       {% elif 'Average' in scan.freshness %}freshness-average
                                       {% elif 'Poor' in scan.freshness %}freshness-poor{% endif %}">
                                {{ scan.expiry_date if scan.product_type == 'branded' else scan.freshness }}
                            </td>
                            <td>{{ scan.count }}</td>
                            <td>
                                <span class="life-days">{{ scan.expected_life_span_days }}</span> days
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination">
                    <button class="pagination-button" onclick="previousPage()" id="prevButton" disabled>Previous</button>
                    <button class="pagination-button" onclick="nextPage()" id="nextButton" {% if recent_scans|length <= 10 %}disabled{% endif %}>Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Format today's date
        const today = new Date();
        const dateOptions = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        const formattedDate = today.toLocaleDateString('en-US', dateOptions);

        // Create pie chart
        const ctx = document.getElementById('productTypeChart').getContext('2d');
        const freshProducts = Number('{{ stats.fresh_products }}');
        const brandedProducts = Number('{{ stats.branded_products }}');
        const todaysBrandedScans = Number('{{ stats.todays_branded_scans }}');
        const todaysFreshScans = Number('{{ stats.todays_fresh_scans }}');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Fresh Items', 'Branded Items'],
                datasets: [{
                    data: [freshProducts, brandedProducts],
                    backgroundColor: [
                        '#4CAF50',
                        '#2196F3'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '70%',
                layout: {
                    padding: {
                        top: 20,
                        bottom: 20,
                        left: 20,
                        right: 20
                    }
                },
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // Update bar chart configuration
        const barCtx = document.getElementById('todayScansChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: [formattedDate],
                datasets: [
                    {
                        label: 'Branded',
                        data: [todaysBrandedScans],
                        backgroundColor: '#4CAF50',
                        barPercentage: 0.4,
                        categoryPercentage: 1
                    },
                    {
                        label: 'Fresh',
                        data: [todaysFreshScans],
                        backgroundColor: '#2196F3',
                        barPercentage: 0.4,
                        categoryPercentage: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    title: {
                        display: false
                    }
                }
            }
        });

        function exportToCSV() {
            const table = document.querySelector('.recent-scans table');
            if (!table) {
                console.error('Table not found');
                alert('No data available to export');
                return;
            }

            let csvContent = [];
            
            // Get headers
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                const headers = Array.from(headerRow.querySelectorAll('th')).map(th => th.textContent.trim());
                csvContent.push(headers.join(','));
            }
            
            // Get data rows
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    let content = '';
                    
                    // Handle type badge cells
                    const typeBadge = cell.querySelector('.type-badge');
                    if (typeBadge) {
                        content = typeBadge.textContent.trim();
                    }
                    // Handle cells with life-days span
                    else if (cell.querySelector('.life-days')) {
                        content = cell.querySelector('.life-days').textContent.trim() + ' days';
                    }
                    // Handle cells with freshness classes
                    else if (cell.classList.contains('freshness-good') || 
                             cell.classList.contains('freshness-average') || 
                             cell.classList.contains('freshness-poor')) {
                        content = cell.textContent.trim();
                    }
                    // Handle regular cells
                    else {
                        content = cell.textContent.trim();
                    }
                    
                    // Escape special characters
                    if (content.includes(',') || content.includes('"') || content.includes('\n')) {
                        content = `"${content.replace(/"/g, '""')}"`;
                    }
                    rowData.push(content);
                });
                csvContent.push(rowData.join(','));
            });

            if (csvContent.length <= 1) {
                alert('No data available to export');
                return;
            }

            // Create the CSV file
            const csv = csvContent.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `product_analysis_${timestamp}.csv`;

            // Create download link
            const link = document.createElement('a');
            if (window.navigator.msSaveOrOpenBlob) {
                // For IE
                window.navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                // For modern browsers
                const url = window.URL.createObjectURL(blob);
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }

        let currentPage = 1;
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                window.location.href = `/dashboard?page=${currentPage}`;
            }
        }
        
        function nextPage() {
            currentPage++;
            window.location.href = `/dashboard?page=${currentPage}`;
        }
    </script>
</body>
</html> 